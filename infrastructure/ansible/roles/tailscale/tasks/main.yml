---
- name: Add Tailscale GPG key
  shell: |
    curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
  args:
    creates: /usr/share/keyrings/tailscale-archive-keyring.gpg

- name: Add Tailscale repository
  copy:
    dest: /etc/apt/sources.list.d/tailscale.list
    content: |
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main

- name: Install Tailscale
  apt:
    name: tailscale
    state: present
    update_cache: yes

- name: Check Tailscale status
  command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Connect to Tailscale
  command: tailscale up --authkey={{ tailscale_authkey }} --accept-routes --accept-dns=false
  when:
    - tailscale_authkey | length > 0
    - tailscale_status.rc != 0
  no_log: true

- name: Enable Tailscale service
  systemd:
    name: tailscaled
    enabled: yes
    state: started
